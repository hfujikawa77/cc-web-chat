# Claude Code Chat システム 要件定義書

## 1. プロジェクト概要

### 1.1 背景・目的
- WSL上で動作するClaude Codeをスマートフォンから簡単に操作可能にする
- チャットベースの直感的なインターフェースによるClaude Code CLI操作
- モバイルデバイスでの開発作業効率向上

### 1.2 実装済みスコープ
- HTTP ベースのチャットインターフェース
- Claude Code CLI との直接統合
- 日本語対応の会話型UI
- Markdownレンダリング対応

## 2. 実装済み機能

### 2.1 チャットインターフェース ✅
- **実装状況**: 完了
- **機能**:
  - LINEライクなチャット形式UI
  - 自然言語での指示入力
  - Claude Code CLI への直接転送
  - 日本語での応答

### 2.2 会話管理 ✅
- **実装状況**: 完了
- **機能**:
  - セッション別会話履歴管理
  - UUID ベースのセッション識別
  - ブラウザローカルストレージ連携
  - 会話コンテキスト保持（最新5メッセージ）

### 2.3 レスポンシブUI ✅
- **実装状況**: 完了
- **機能**:
  - スマートフォン最適化デザイン
  - タイピングインジケーター
  - メッセージタイムスタンプ
  - 例文クリック機能

### 2.4 ストリーミング機能 ✅
- **実装状況**: 完了
- **機能**:
  - Server-Sent Events による双方向通信
  - `claude --output-format stream-json` の JSON ストリーム解析
  - リアルタイム進捗表示（🔄⚙️💭✅）
  - コスト・実行時間の可視化
  - AbortController によるタイムアウト制御（3分）
  - ストリーミング失敗時の通常API自動フォールバック

### 2.5 会話文脈管理 ✅
- **実装状況**: 完了
- **機能**:
  - 選択肢→回答の流れを理解した対話
  - 最新10メッセージの履歴をClaude Codeに送信
  - 「前の会話の文脈を理解して適切に応答してください」指示
  - セッション別の会話履歴管理（50メッセージ保存）

### 2.6 条件付きMarkdownレンダリング ✅
- **実装状況**: 完了
- **機能**:
  - .mdファイル検出（拡張子、README、REQUIREMENTS等）
  - .mdファイル時: フルMarkdown機能
  - 通常ファイル時: 最小限フォーマット（コードブロック、太字のみ）
  - 見出し、リスト、引用、リンク、水平線対応
  - カスタム軽量パーサーによる高速処理

### 2.7 コードハイライト ✅
- **実装状況**: 完了
- **機能**:
  - Prism.js による多言語対応
  - コピー機能付きコードブロック
  - 言語別カスタマイズ表示
  - ダークテーマ対応

## 3. 未実装機能（将来拡張）

### 3.1 ファイル操作機能 🔄
- **計画**: Phase 2
- **機能**:
  - ファイルブラウザ
  - ファイルビューア
  - 基本的なファイル操作

### 3.2 プロジェクト管理 🔄
- **計画**: Phase 2
- **機能**:
  - プロジェクト切り替え
  - 設定管理
  - 履歴管理

## 4. 技術仕様

### 4.1 現在のアーキテクチャ ✅
```
[スマートフォンブラウザ] ←→ [HTML Chat UI] ←→ [HTTP Server] ←→ [Claude Code CLI]
                                ↓                 ↓
                         [ストリーミング]    [Session Storage]
                         [進捗表示]          [会話文脈]
```

### 4.2 技術スタック ✅
- **フロントエンド**: Vanilla JavaScript, HTML5, CSS3
- **バックエンド**: Python HTTP Server (標準ライブラリ)
- **ストリーミング**: Server-Sent Events (SSE)
- **Markdown**: 条件付きカスタム軽量パーサー
- **シンタックスハイライト**: Prism.js
- **セッション管理**: メモリ内辞書 + localStorage

### 4.3 通信仕様 ✅
- **プロトコル**: HTTP POST (JSON) + Server-Sent Events
- **エンドポイント**: `/api/chat/stream` (ストリーミング), `/api/chat` (フォールバック)
- **ポート**: 8081
- **エンコーディング**: UTF-8
- **タイムアウト**: 180秒（3分）
- **Claude Code CLI**: `--output-format stream-json --verbose` でリアルタイム進捗

## 5. 実装詳細

### 5.1 サーバーサイド (claude_chat_server.py) ✅
- **機能**: Claude Code CLI ラッパー（ストリーミング対応）
- **セッション管理**: UUID ベース、最大50メッセージ履歴
- **コンテキスト**: 最新10メッセージを Claude Code に転送
- **ストリーミング**: JSON Stream 解析、進捗データ送信
- **エラーハンドリング**: 3分タイムアウト、プロセス管理、接続エラー
- **会話文脈**: 選択肢→回答の流れを理解した応答生成

### 5.2 クライアントサイド (claude_chat.html) ✅  
- **UI**: レスポンシブチャットインターフェース（ストリーミング対応）
- **ストリーミング**: Server-Sent Events による進捗表示
- **Markdown**: 条件付きレンダリング（.mdファイルのみフル機能）
- **パフォーマンス**: メモ化、requestAnimationFrame最適化
- **UX**: リアルタイム進捗、コスト・時間表示、コピー機能
- **エラー処理**: フォールバック機能、タイムアウト制御

## 6. 運用要件

### 6.1 動作環境 ✅
- **OS**: Windows 11 + WSL2 (Ubuntu)
- **Python**: 3.8以上（標準ライブラリのみ使用）
- **Claude Code**: 有効なライセンスとCLI環境
- **ブラウザ**: Chrome/Safari/Edge (モバイル対応)

### 6.2 起動方法 ✅
```bash
# シンプルな起動
python claude_chat_server.py

# アクセス
http://127.0.0.1:8081/claude_chat.html
```

### 6.3 設定 ✅
- **ポート**: 8081（固定）
- **タイムアウト**: 180秒（3分）
- **セッション履歴**: 50メッセージ
- **コンテキスト**: 10メッセージ
- **文字エンコーディング**: UTF-8
- **ストリーミング**: Server-Sent Events 対応
- **フォールバック**: 自動切り替え機能

## 7. 使用例

### 7.1 基本的な使用シナリオ ✅

#### 実際の使用例（ストリーミング対応）:
1. スマートフォンで `http://127.0.0.1:8081/claude_chat.html` にアクセス
2. 「test.py ファイルを作って」とチャットで送信  
3. リアルタイム進捗表示: 🔄 処理開始 → ⚙️ システム準備 → 💭 応答中 → ✅ 完了
4. コスト・時間情報: 💰 $0.0127  ⏱️ 4.2秒
5. 結果が適切にフォーマットされて表示（.mdファイルの場合はMarkdown、コードファイルは最小限）

#### 会話文脈の理解例:
```
Claude: 実行したい具体的なコマンドやファイルを教えてください。例えば：
1. python calculator.py を実行したい
2. claude_chat_server.py のコードを見たい  
3. 特定のファイルの内容を読みたい

User: 1
→ Claude が「1番目の選択肢」を理解してcalculator.pyを実行
```

#### 対応可能な指示例:
- 「calculator.py を作って」
- 「README.md を表示して」（Markdownレンダリング）
- 「エラーを修正して」
- 「このコードを改善して」  
- 「1」（前回の選択肢への回答）

### 7.2 会話の継続性・文脈理解 ✅
- 前の会話内容（最新10メッセージ）をClaude Codeに送信
- 選択肢→回答の流れを理解した対話
- セッション別の会話履歴管理
- 「それを修正して」「1番目を実行して」のような文脈依存の指示に対応

## 8. セキュリティ・制約事項

### 8.1 現在の制約事項
- **ネットワーク**: ローカルネットワーク内での使用（127.0.0.1）
- **認証**: なし（ローカル開発環境想定）
- **ファイルアクセス**: Claude Code CLI のアクセス権限に依存
- **セッション**: メモリ内保存（サーバー再起動で消失）

### 8.2 前提条件 ✅
- Windows 11 + WSL2環境
- Python 3.8以上（標準ライブラリのみ）
- Claude Code CLIの有効なライセンスと設定
- インターネット接続（Claude Code API使用のため）

## 9. 今後の拡張計画

### 9.1 Phase 2 候補機能 🔄
- **ファイルブラウザ**: プロジェクト内ファイル一覧表示
- **セッション永続化**: ファイルベースの履歴保存
- **リアルタイムコラボレーション**: 複数ユーザー同時編集
- **プロジェクト管理**: 複数プロジェクトの切り替え

### 9.2 Phase 3 候補機能 🔄  
- **認証システム**: 基本認証またはトークンベース
- **Git統合**: コミット・プッシュ・プル操作  
- **PWA対応**: オフライン機能とアプリ化
- **デスクトップアプリ**: Electron による統合アプリ

## 10. 開発ノート

### 10.1 アーキテクチャの判断理由
- **シンプルさ優先**: 標準ライブラリのみでメンテナンス容易
- **軽量**: 外部依存関係を最小化（Prism.jsのみ）
- **即効性**: 設定不要でそのまま動作
- **モバイル最適**: スマートフォンでの使用を重視
- **ストリーミング**: Claude Code の新機能を最大活用

### 10.2 技術的工夫・最適化
- **ストリーミング**: Server-Sent Events でリアルタイム体験
- **条件付きMarkdown**: ファイル種別に応じた最適なレンダリング
- **会話文脈**: 選択肢→回答の自然な対話フロー
- **フォールバック**: 障害時の自動復旧機能
- **タイムアウト制御**: 3分の適切なバランス
- **セッション管理**: UUIDベースで複数端末対応
- **パフォーマンス**: メモ化、requestAnimationFrame最適化
- **レスポンシブ**: モバイルファーストデザイン

### 10.3 実装上の特徴
- **プロセス管理**: signal による確実なタイムアウト処理
- **接続管理**: 適切なリソース解放でハング防止
- **エラー処理**: ユーザーフレンドリーな日本語メッセージ
- **プログレス表示**: アイコンとアニメーションによる視覚的フィードバック