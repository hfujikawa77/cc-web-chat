<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Chat - ä¼šè©±å‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</title>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #1a1a1a;
            color: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-family: 'Courier New', monospace;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 500;
            display: none;
        }
        
        .ascii-banner {
            text-align: center;
            font-size: 10px;
            line-height: 1;
            white-space: pre;
            overflow-x: auto;
            margin: 0 auto;
            max-width: 100%;
        }
        
        .ascii-cc { color: #00D9FF; }
        .ascii-web { color: #00FF00; }
        .ascii-chat { color: #FF00FF; }
        
        @media (max-width: 768px) {
            .ascii-banner {
                font-size: 6px;
            }
        }
        
        @media (max-width: 480px) {
            .ascii-banner {
                font-size: 4px;
            }
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            scroll-behavior: smooth;
        }
        
        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.2s ease-in;
            will-change: transform, opacity;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            text-align: right;
        }
        
        .message-content {
            display: inline-block;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }
        
        .user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
            text-align: left;
        }
        
        /* ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã®ã‚«ãƒ¼ã‚½ãƒ« */
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background: #007bff;
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: text-bottom;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* é‡è¦: ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®æ”¹è¡Œã‚’ä¿æŒã™ã‚‹CSS */
        .message-content pre {
            background: #272822 !important;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            overflow-x: auto;
            margin: 0 0 10px 0;
            border: none;
            position: relative;
            /* æ”¹è¡Œã‚’ä¿æŒã™ã‚‹é‡è¦ãªè¨­å®š */
            white-space: pre !important;
            overflow-wrap: normal !important;
            word-wrap: normal !important;
            word-break: normal !important;
            max-height: 400px;
            max-width: 100%;
        }
        
        .message-content pre code {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            color: #f8f8f2 !important;
            font-family: 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.5;
            /* æ”¹è¡Œã‚’ä¿æŒã™ã‚‹é‡è¦ãªè¨­å®š */
            white-space: pre !important;
            overflow-wrap: normal !important;
            word-wrap: normal !important;
            word-break: normal !important;
            display: block;
            width: 100%;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e1e1e;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            font-size: 12px;
            color: #888;
            margin: 10px 0 0 0;
        }
        
        .copy-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }
        
        .copy-button:hover {
            background: #0056b3;
        }
        
        /* Prism.jsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ */
        .message-content pre[class*="language-"] {
            white-space: pre !important;
            overflow-x: auto !important;
            overflow-y: auto !important;
            max-height: 400px !important;
            tab-size: 4 !important;
            -moz-tab-size: 4 !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            word-wrap: normal !important;
            overflow-wrap: normal !important;
        }
        
        .message-content code[class*="language-"] {
            white-space: pre !important;
            tab-size: 4 !important;
            -moz-tab-size: 4 !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            font-size: 14px !important;
            line-height: 1.5 !important;
            word-wrap: normal !important;
            overflow-wrap: normal !important;
        }
        
        .message-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
        
        /* Markdownè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 16px 0 8px 0;
            font-weight: 600;
            line-height: 1.25;
        }
        
        .message-content h1 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.1em; }
        
        .message-content p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .message-content ul, .message-content ol {
            margin: 8px 0;
            padding-left: 24px;
        }
        
        .message-content li {
            margin: 4px 0;
            line-height: 1.6;
        }
        
        .message-content blockquote {
            margin: 8px 0;
            padding: 8px 16px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
            color: #666;
        }
        
        .message-content table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
            max-width: 100%;
            overflow: auto;
        }
        
        .message-content th, .message-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        .message-content th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .message-content tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .message-content a {
            color: #007bff;
            text-decoration: none;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .message-content a:hover,
        .message-content a:active {
            text-decoration: underline;
            background-color: #e7f3ff;
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¿ãƒƒãƒ—ã‚¨ãƒªã‚¢æ‹¡å¤§ */
        @media (max-width: 768px) {
            .message-content a {
                padding: 8px 6px;
                margin: 2px 0;
                display: inline-block;
                min-height: 44px;
                line-height: 1.4;
            }
        }
        
        .message-content hr {
            margin: 16px 0;
            border: none;
            border-top: 1px solid #e0e0e0;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content strong {
            font-weight: 600;
        }
        
        .message-content del {
            text-decoration: line-through;
            color: #999;
        }
        
        /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
        .message-content input[type="checkbox"] {
            margin-right: 6px;
        }
        
        .message-content .task-list-item {
            list-style: none;
            margin-left: -24px;
        }
        
        /* é€²æ—æƒ…å ±ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .progress-info {
            background: #f0f8ff;
            border: 1px solid #e0e8f0;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 8px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: pulse 2s infinite;
        }
        
        .progress-phase {
            font-weight: 500;
            color: #2c5aa0;
            flex: 1;
        }
        
        .progress-cost {
            background: #fff3cd;
            color: #856404;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .progress-duration {
            background: #d1ecf1;
            color: #0c5460;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .completion-stats {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 0 0 0;
            font-size: 12px;
            color: #155724;
            text-align: right;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .directory-bar {
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .directory-bar span {
            flex: 1;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
        }

        .directory-bar button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            min-width: 32px;
            height: 24px;
        }

        .directory-bar button:hover {
            background: #495057;
        }
        
        .input-container {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        
        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #messageInput:focus {
            border-color: #007bff;
        }
        
        #sendButton {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        #sendButton:hover {
            background: #0056b3;
        }
        
        #sendButton:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: none;
            padding: 20px;
        }
        
        .typing-indicator.show {
            display: block;
        }
        
        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .typing-dots span {
            display: block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }
        
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        .examples {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .examples h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .example-chip {
            display: inline-block;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 16px;
            margin: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .example-chip:hover {
            background: #e0e0e0;
        }
        
        /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
        .message-content img {
            will-change: transform;
        }
        
        /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ­ãƒ¼ãƒ€ãƒ¼ */
        .skeleton-loader {
            display: inline-block;
            height: 20px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– Claude Code Web Chat</h1>
        <div class="ascii-banner">
<span class="ascii-cc">  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— </span>    <span class="ascii-web">â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— </span>      <span class="ascii-chat">â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—</span>
<span class="ascii-cc"> â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â• </span>    <span class="ascii-web">â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—</span>     <span class="ascii-chat">â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•— â•šâ•â•â–ˆâ–ˆâ•”â•â•â•</span>
<span class="ascii-cc"> â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘      </span>    <span class="ascii-web">â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•</span>     <span class="ascii-chat">â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   </span>
<span class="ascii-cc"> â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘      </span>    <span class="ascii-web">â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â•   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—</span>     <span class="ascii-chat">â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   </span>
<span class="ascii-cc"> â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— </span>    <span class="ascii-web">â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•</span>     <span class="ascii-chat">â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘   </span>
<span class="ascii-cc">  â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• </span>     <span class="ascii-web">â•šâ•â•â•â•šâ•â•â•  â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• </span>      <span class="ascii-chat">â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â• â•šâ•â•  â•šâ•â•    â•šâ•â•   </span>
        </div>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="examples">
            <h3>ğŸ’¡ ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©¦ã—ã¦ã¿ã‚‹ï¼š</h3>
            <span class="example-chip" onclick="sendExample('hello.py ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦')">hello.py ä½œæˆ</span>
            <span class="example-chip" onclick="sendExample('ã©ã‚“ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œã‚Œã¾ã™ã‹ï¼Ÿ')">ä½œæˆå¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«</span>
            <span class="example-chip" onclick="sendExample('ç°¡å˜ãªWebã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã£ã¦')">Webã‚µãƒ¼ãƒãƒ¼ä½œæˆ</span>
            <span class="example-chip" onclick="sendExample('GitHub Issues ã®URLãƒªãƒ³ã‚¯ä»˜ãä¸€è¦§ã‚’å‡ºã—ã¦')">GitHub Issues ä¸€è¦§</span>
            <span class="example-chip" onclick="sendExample('GitHub Pull Requests ã®URLãƒªãƒ³ã‚¯ä»˜ãä¸€è¦§ã‚’å‡ºã—ã¦')">GitHub PRs ä¸€è¦§</span>
        </div>
        
        <div id="messages"></div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="message assistant">
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ãƒãƒ¼ -->
    <div class="directory-bar">
        <span id="currentDirectory">ğŸ“ èª­ã¿è¾¼ã¿ä¸­...</span>
        <button id="directoryInfoButton" onclick="showDirectoryInfo()" title="ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã‚’è¡¨ç¤º">ğŸ“‹</button>
        <button id="directoryUpButton" onclick="goUpDirectory()" title="ä¸Šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸">â¬†ï¸</button>
    </div>
    
    <div class="input-container">
        <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autofocus>
        <button id="sendButton" onclick="sendMessage()">é€ä¿¡</button>
    </div>

    <script>
        let sessionId = localStorage.getItem('claude_chat_session') || generateSessionId();
        localStorage.setItem('claude_chat_session', sessionId);
        let currentStreamingMessage = null;
        let currentController = null; // ç¾åœ¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶å¾¡ç”¨
        let currentDirectory = '';
        
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ã‚’ãƒ¡ãƒ¢åŒ–
        const memoizedFormatters = new Map();
        
        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ“ä½œé–¢æ•°
        async function updateDirectoryInfo() {
            try {
                const response = await fetch('/api/directory/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentDirectory = result.current_directory;
                    document.getElementById('currentDirectory').textContent = `ğŸ“ ${currentDirectory}`;
                }
            } catch (error) {
                console.error('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
            }
        }
        
        async function changeDirectory(path) {
            try {
                const response = await fetch('/api/directory/change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        session_id: sessionId,
                        path: path 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentDirectory = result.current_directory;
                        
                        // ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‹ã©ã†ã‹ã§è¡¨ç¤ºã‚’å¤‰æ›´
                        const isSymlink = result.message.includes('ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯');
                        const icon = isSymlink ? 'ğŸ”—' : 'ğŸ“';
                        document.getElementById('currentDirectory').textContent = `${icon} ${currentDirectory}`;
                        
                        addMessage(result.message, 'system');
                    } else {
                        addMessage(`ã‚¨ãƒ©ãƒ¼: ${result.message}`, 'system');
                    }
                } else {
                    addMessage('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'system');
                }
            } catch (error) {
                console.error('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤‰æ›´ã«å¤±æ•—:', error);
                addMessage('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¤‰æ›´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'system');
            }
        }
        
        async function showDirectoryInfo() {
            try {
                const response = await fetch('/api/directory/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    let content = `ğŸ“ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${result.current_directory}\n\n`;
                    
                    if (result.items && result.items.length > 0) {
                        content += 'ğŸ“‹ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:\n';
                        result.items.forEach(item => {
                            const icon = item.is_directory ? 'ğŸ“' : 'ğŸ“„';
                            content += `${icon} ${item.name}\n`;
                        });
                    } else {
                        content += '(ç©ºã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãªã—)';
                    }
                    
                    addMessage(content, 'system');
                }
            } catch (error) {
                console.error('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã®å–å¾—ã«å¤±æ•—:', error);
                addMessage('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã®å–å¾—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'system');
            }
        }
        
        function goUpDirectory() {
            const parentPath = '..';
            changeDirectory(parentPath);
        }
        
        function addMessage(content, type = 'assistant', isStreaming = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            if (type === 'system') {
                messageDiv.style.opacity = '0.8';
                messageDiv.style.fontStyle = 'italic';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isStreaming) {
                // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ç”¨ã®åˆæœŸè¡¨ç¤º
                contentDiv.innerHTML = '<div class="skeleton-loader" style="width: 200px;"></div>';
                currentStreamingMessage = contentDiv;
            } else {
                contentDiv.innerHTML = formatMessage(content);
            }
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date().toLocaleTimeString('ja-JP');
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestamp);
            messagesDiv.appendChild(messageDiv);
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆrequestAnimationFrameã§æœ€é©åŒ–ï¼‰
            requestAnimationFrame(() => {
                const container = document.getElementById('chatContainer');
                container.scrollTop = container.scrollHeight;
            });
            
            return contentDiv;
        }
        
        // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ›´æ–°ç”¨ã®é–¢æ•°
        function updateStreamingMessage(content, isComplete = false, progressInfo = null) {
            if (!currentStreamingMessage) return;
            
            // é€²æ—æƒ…å ±ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
            if (progressInfo && progressInfo.message && !isComplete) {
                const progressHtml = `<div class="progress-info">
                    <span class="progress-phase">${getPhaseIcon(progressInfo.phase)} ${progressInfo.message}</span>
                    ${progressInfo.cost > 0 ? `<span class="progress-cost">ğŸ’° $${progressInfo.cost.toFixed(4)}</span>` : ''}
                    ${progressInfo.duration > 0 ? `<span class="progress-duration">â±ï¸ ${(progressInfo.duration/1000).toFixed(1)}s</span>` : ''}
                </div>`;
                
                if (content) {
                    const formattedContent = formatMessage(content);
                    currentStreamingMessage.innerHTML = progressHtml + '<hr>' + formattedContent + '<span class="streaming-cursor"></span>';
                } else {
                    currentStreamingMessage.innerHTML = progressHtml + '<span class="streaming-cursor"></span>';
                }
            } else if (isComplete) {
                // æœ€çµ‚è¡¨ç¤ºæ™‚ã¯é€²æ—æƒ…å ±ã‚’å‰Šé™¤
                const finalContent = content ? formatMessage(content) : '';
                currentStreamingMessage.innerHTML = finalContent;
                
                // å®Œäº†æ™‚ã«çµ±è¨ˆæƒ…å ±ã‚’è¿½åŠ 
                if (progressInfo && (progressInfo.cost > 0 || progressInfo.duration > 0)) {
                    const statsHtml = `<div class="completion-stats">
                        ${progressInfo.cost > 0 ? `ğŸ’° ã‚³ã‚¹ãƒˆ: $${progressInfo.cost.toFixed(4)}` : ''}
                        ${progressInfo.duration > 0 ? ` â±ï¸ å®Ÿè¡Œæ™‚é–“: ${(progressInfo.duration/1000).toFixed(1)}ç§’` : ''}
                    </div>`;
                    currentStreamingMessage.innerHTML += statsHtml;
                }
                
                currentStreamingMessage = null;
                
                // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’éåŒæœŸã§é©ç”¨
                requestIdleCallback(() => {
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                }, { timeout: 500 });
            } else {
                // é€šå¸¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°
                const formattedContent = formatMessage(content);
                currentStreamingMessage.innerHTML = formattedContent + '<span class="streaming-cursor"></span>';
            }
        }
        
        function getPhaseIcon(phase) {
            const icons = {
                'init': 'ğŸ”„',
                'system': 'âš™ï¸',
                'responding': 'ğŸ’­',
                'complete': 'âœ…'
            };
            return icons[phase] || 'ğŸ“¡';
        }
        
        function formatMessage(content, isMarkdown = null) {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
            const cacheKey = content.substring(0, 100);
            if (memoizedFormatters.has(cacheKey) && content.length < 500) {
                return memoizedFormatters.get(cacheKey);
            }
            
            // Markdownã‹ã©ã†ã‹ã®åˆ¤å®š
            if (isMarkdown === null) {
                isMarkdown = detectMarkdownContent(content);
            }
            
            // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ä¿è­·
            const codeBlocks = [];
            let codeBlockIndex = 0;
            
            // ãƒ•ã‚§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ```ï¼‰ã®å‡¦ç†
            content = content.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || 'text';
                const languageClass = `language-${language}`;
                const displayLang = getLanguageDisplayName(language);
                const codeId = 'code_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const codeBlock = `<div class="code-header"><span>${displayLang}</span><button class="copy-button" onclick="copyCode('${codeId}')">ã‚³ãƒ”ãƒ¼</button></div><pre><code id="${codeId}" class="${languageClass}">${escapeHtml(code.trim())}</code></pre>`;
                codeBlocks.push(codeBlock);
                return `\n%%%CODEBLOCK${codeBlockIndex++}%%%\n`;
            });
            
            // HTMLã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            content = escapeHtml(content);
            
            if (isMarkdown) {
                // Markdownã®å ´åˆã®ã¿ãƒ•ãƒ«æ©Ÿèƒ½ã‚’é©ç”¨
                
                // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
                content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // è¦‹å‡ºã—
                content = content.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
                content = content.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
                content = content.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
                
                // å¤ªå­—
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // æ–œä½“
                content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
                
                // å–ã‚Šæ¶ˆã—ç·š
                content = content.replace(/~~(.*?)~~/g, '<del>$1</del>');
                
                // ãƒªã‚¹ãƒˆï¼ˆç•ªå·ãªã—ï¼‰
                content = content.replace(/^[\*\-] (.*)$/gm, '<li>$1</li>');
                content = content.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                    return '<ul>' + match + '</ul>';
                });
                
                // ãƒªã‚¹ãƒˆï¼ˆç•ªå·ä»˜ãï¼‰
                content = content.replace(/^\d+\. (.*)$/gm, '<li>$1</li>');
                content = content.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                    if (!match.includes('<ul>')) {
                        return '<ol>' + match + '</ol>';
                    }
                    return match;
                });
                
                // å¼•ç”¨
                content = content.replace(/^&gt; (.*)$/gm, '<blockquote>$1</blockquote>');
                content = content.replace(/(<blockquote>.*<\/blockquote>\n?)+/g, (match) => {
                    return match.replace(/<\/blockquote>\n?<blockquote>/g, '<br>');
                });
                
                // æ°´å¹³ç·š
                content = content.replace(/^---$/gm, '<hr>');
                
                // ãƒªãƒ³ã‚¯
                content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            } else {
                // é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯æœ€å°é™ã®å‡¦ç†
                
                // Markdownãƒªãƒ³ã‚¯ï¼ˆé‡è¦ï¼šGitHub Issues/PRsç”¨ï¼‰
                content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
                
                // ç”Ÿã®URLï¼ˆhttps://ã§å§‹ã¾ã‚‹URLï¼‰
                content = content.replace(/(^|[^"])(https?:\/\/[^\s<>"]+)/g, '$1<a href="$2" target="_blank" rel="noopener">$2</a>');
                
                // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã¿
                content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // å¤ªå­—ã®ã¿
                content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }
            
            // æ”¹è¡Œ
            content = content.replace(/\n/g, '<br>');
            
            // æœ€çµ‚çš„ã«å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒªãƒ³ã‚¯å‡¦ç†ã‚’å¼·åˆ¶å®Ÿè¡Œï¼ˆGitHub Issues/PRsç¢ºå®Ÿå¯¾å¿œï¼‰
            // æ—¢å­˜ã®aã‚¿ã‚°ã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã«æ…é‡ã«å‡¦ç†
            if (!content.includes('<a href=')) {
                content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
                content = content.replace(/(^|[^">])(https?:\/\/[^\s<>"]+)/g, '$1<a href="$2" target="_blank" rel="noopener">$2</a>');
            }
            
            // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å¾©å…ƒ
            codeBlocks.forEach((codeBlock, index) => {
                content = content.replace(`%%%CODEBLOCK${index}%%%`, codeBlock);
            });
            
            // é€£ç¶šã—ãŸ<br>ã‚’å‰Šé™¤
            content = content.replace(/(<br>){3,}/g, '<br><br>');
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
            if (content.length < 500) {
                memoizedFormatters.set(cacheKey, content);
            }
            
            return content;
        }
        
        function detectMarkdownContent(content) {
            // Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const mdIndicators = [
                /\.md\b/i,
                /README/i,
                /REQUIREMENTS/i,
                /CHANGELOG/i,
                /^#+ /m,  // è¦‹å‡ºã—è¨˜æ³•
                /\*\*.*?\*\*/,  // å¤ªå­—è¨˜æ³•
                /\[.*?\]\(.*?\)/,  // ãƒªãƒ³ã‚¯è¨˜æ³•
                /^[\*\-] /m,  // ãƒªã‚¹ãƒˆè¨˜æ³•
                /^>/m  // å¼•ç”¨è¨˜æ³•
            ];
            
            return mdIndicators.some(pattern => pattern.test(content));
        }
        
        function getLanguageDisplayName(lang) {
            const languageNames = {
                'python': 'Python',
                'javascript': 'JavaScript',
                'js': 'JavaScript',
                'html': 'HTML',
                'css': 'CSS',
                'bash': 'Bash',
                'sh': 'Shell',
                'json': 'JSON',
                'sql': 'SQL',
                'yaml': 'YAML',
                'xml': 'XML',
                'java': 'Java',
                'cpp': 'C++',
                'c': 'C',
                'php': 'PHP',
                'ruby': 'Ruby',
                'go': 'Go',
                'rust': 'Rust',
                'typescript': 'TypeScript',
                'ts': 'TypeScript'
            };
            return languageNames[lang.toLowerCase()] || lang.toUpperCase();
        }
        
        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // ä¸€æ™‚çš„ã«ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿!';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#007bff';
                }, 1500);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
            });
        }
        
        function escapeHtml(text) {
            // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’è¡Œã†ãŒã€æ”¹è¡Œæ–‡å­—ã¯ä¿æŒã™ã‚‹
            const escapeMap = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            };
            
            return text.replace(/[&<>"']/g, char => escapeMap[char]);
        }
        
        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚³ãƒãƒ³ãƒ‰ã‚’å‡¦ç†
        async function handleDirectoryCommands(message) {
            const trimmed = message.trim().toLowerCase();
            
            // cdã‚³ãƒãƒ³ãƒ‰
            if (trimmed.startsWith('cd ')) {
                const path = message.slice(3).trim();
                addMessage(message, 'user');
                await changeDirectory(path);
                return true;
            }
            
            // lsã‚³ãƒãƒ³ãƒ‰
            if (trimmed === 'ls' || trimmed === 'dir') {
                addMessage(message, 'user');
                await showDirectoryInfo();
                return true;
            }
            
            // pwdã‚³ãƒãƒ³ãƒ‰
            if (trimmed === 'pwd') {
                addMessage(message, 'user');
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã‚’å–å¾—
                await updateDirectoryInfo();
                addMessage(`ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${currentDirectory}`, 'system');
                return true;
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±è¡¨ç¤ºã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (trimmed === 'session' || trimmed === 'debug') {
                addMessage(message, 'user');
                addMessage(`ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: ${sessionId}
- ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${currentDirectory}
- ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤º: ${document.getElementById('currentDirectory').textContent}`, 'system');
                return true;
            }
            
            return false;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            const sendButton = document.getElementById('sendButton');
            // å³åº§ã«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ï¼‰
            if (sendButton.disabled) return; // æ—¢ã«å‡¦ç†ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
            sendButton.disabled = true;
            
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚³ãƒãƒ³ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
            if (await handleDirectoryCommands(message)) {
                input.value = '';
                sendButton.disabled = false; // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚³ãƒãƒ³ãƒ‰ã¯å³åº§ã«å®Œäº†
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³åº§ã«è¡¨ç¤º
            addMessage(message, 'user');
            input.value = '';
            
            // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ä½œæˆ
            const assistantContent = addMessage('', 'assistant', true);
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
            const controller = new AbortController();
            currentController = controller; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
            const timeoutId = setTimeout(() => {
                controller.abort();
            }, 180000); // 3åˆ†ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            
            try {
                // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è©¦ã¿ã‚‹
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                    await handleStreamingResponse(response, controller);
                } else {
                    // é€šå¸¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                    const data = await response.json();
                    updateStreamingMessage(data.response, true);
                }
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    updateStreamingMessage('â° ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', true);
                    return;
                }
                
                console.log('Streaming failed, trying fallback:', error);
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®APIã‚’ä½¿ç”¨
                try {
                    const fallbackController = new AbortController();
                    const fallbackTimeoutId = setTimeout(() => {
                        fallbackController.abort();
                    }, 180000); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚3åˆ†
                    
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: sessionId
                        }),
                        signal: fallbackController.signal
                    });
                    
                    clearTimeout(fallbackTimeoutId);
                    const data = await response.json();
                    updateStreamingMessage(data.response, true);
                } catch (fallbackError) {
                    if (fallbackError.name === 'AbortError') {
                        updateStreamingMessage('â° ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', true);
                    } else {
                        updateStreamingMessage('âŒ ã‚¨ãƒ©ãƒ¼: ' + fallbackError.message, true);
                    }
                }
            } finally {
                currentController = null; // åˆ¶å¾¡ã‚’ã‚¯ãƒªã‚¢
                sendButton.disabled = false;
                // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
                input.focus();
            }
        }
        
        async function handleStreamingResponse(response, controller = null) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let finalContent = '';
            let progressInfo = {
                phase: 'init',
                cost: 0,
                duration: 0
            };
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                // æœ€çµ‚æ›´æ–°
                                updateStreamingMessage(finalContent, true, progressInfo);
                                return;
                            } else {
                                try {
                                    const chunk = JSON.parse(data);
                                    const processed = processStreamChunk(chunk, progressInfo);
                                    
                                    if (processed.content) {
                                        finalContent = processed.content;
                                        updateStreamingMessage(finalContent, false, progressInfo);
                                    } else if (processed.progress) {
                                        updateStreamingMessage(finalContent, false, progressInfo);
                                    }
                                    
                                } catch (e) {
                                    console.log('JSON parse error:', e, 'Data:', data);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Streaming error:', error);
                updateStreamingMessage('âŒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, true);
            } finally {
                // ç¢ºå®Ÿã«readerã‚’é–‰ã˜ã‚‹
                try {
                    reader.releaseLock();
                } catch (e) {
                    console.log('Reader release error:', e);
                }
            }
        }
        
        function processStreamChunk(chunk, progressInfo) {
            const type = chunk.type;
            let hasContent = false;
            let hasProgress = false;
            
            switch (type) {
                case 'system':
                    progressInfo.phase = 'system';
                    progressInfo.message = chunk.message || 'ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...';
                    hasProgress = true;
                    break;
                    
                case 'assistant':
                    progressInfo.phase = 'responding';
                    progressInfo.message = 'Claude CodeãŒå¿œç­”ä¸­...';
                    if (chunk.content) {
                        hasContent = true;
                        return { content: chunk.content };
                    }
                    hasProgress = true;
                    break;
                    
                case 'result':
                    progressInfo.phase = 'complete';
                    progressInfo.message = 'å‡¦ç†å®Œäº†';
                    progressInfo.cost = chunk.cost || 0;
                    progressInfo.duration = chunk.duration || 0;
                    if (chunk.content) {
                        hasContent = true;
                        return { content: chunk.content };
                    }
                    hasProgress = true;
                    break;
                    
                case 'init':
                    progressInfo.phase = 'init';
                    progressInfo.message = chunk.message || 'å‡¦ç†é–‹å§‹...';
                    hasProgress = true;
                    break;
            }
            
            return { hasContent, hasProgress, progress: hasProgress };
        }
        
        function sendExample(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }
        
        // Enterã‚­ãƒ¼ã§é€ä¿¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const sendButton = document.getElementById('sendButton');
                if (!sendButton.disabled) { // å‡¦ç†ä¸­ã§ãªã‘ã‚Œã°é€ä¿¡
                    sendMessage();
                }
            }
        });
        
        // ESCã‚­ãƒ¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && currentController) {
                console.log('ESCã‚­ãƒ¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                currentController.abort();
                updateStreamingMessage('âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', true);
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                const sendButton = document.getElementById('sendButton');
                sendButton.disabled = false;
                
                // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
                const input = document.getElementById('messageInput');
                input.focus();
                
                currentController = null;
            }
        });
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        addMessage(`ã“ã‚“ã«ã¡ã¯ï¼Claude Code Chatã§ã™ã€‚

ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã‚„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã™ã€‚
ğŸ¯ ã€Œtest_work.py ã‚’ä½œã£ã¦ã€ã®ã‚ˆã†ã«ãŠè©±ã—ãã ã•ã„ã€‚
ğŸ’¬ ä¼šè©±ã®æ–‡è„ˆã‚’ç†è§£ã—ã¦é©åˆ‡ã«å¯¾å¿œã—ã¾ã™ã€‚
âš¡ å‡¦ç†ä¸­ã« **ESCã‚­ãƒ¼** ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ã§ã™ã€‚

ä½•ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ`);
        
        // åˆæœŸåŒ–å‡¦ç†
        window.addEventListener('load', () => {
            // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæƒ…å ±ã‚’å–å¾—
            updateDirectoryInfo();
            
            // å¿…è¦ã«å¿œã˜ã¦Prism.jsã‚’é©ç”¨
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
    </script>
    
    <!-- Prism.js scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
</body>
</html>