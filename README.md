# Claude Code Chat UI - ストリーミング対応チャット型インターフェース

HTTP + Claude Code CLI 直接統合によるリアルタイムストリーミングチャットシステム

## 概要

スマートフォンブラウザから Claude Code CLI を操作できる本格的なチャット型WebUIです。ストリーミング対応により、Claude Codeの実行状況をリアルタイムで確認できます。

## ✨ 主要機能

### 🚀 ストリーミング対応
- **リアルタイム進捗表示**: Claude Codeの実行状況をリアルタイムで表示
- **Server-Sent Events**: 双方向通信による即座な応答
- **進捗アイコン**: 🔄 初期化 → ⚙️ システム準備 → 💭 応答中 → ✅ 完了
- **コスト・時間表示**: 実行コストと処理時間の可視化

### 💬 高度なチャットインターフェース
- **日本語サポート**: UTF-8エンコーディングによる完全な日本語表示
- **モダンUI**: レスポンシブデザインとリアルタイムタイピング表示
- **会話文脈保持**: 選択肢→回答の流れを理解した対話
- **Markdownレンダリング**: .mdファイル時の美しい表示
- **コードハイライト**: 多言語対応シンタックスハイライト

### 🔧 Claude Code 統合
- **ストリーミング実行**: `--output-format stream-json` による進捗表示
- **権限バイパス**: ファイル作成権限を自動的に許可
- **文脈理解**: 会話履歴を含む適切な応答
- **3分タイムアウト**: 長時間処理にも対応
- **フォールバック機能**: ストリーミング失敗時の通常モード切り替え

## 📁 ファイル操作
- **ファイル作成**: Claude Code CLIが直接ファイルを作成
- **プログラミング支援**: Python、JavaScript等のファイル生成
- **テストファイル**: 自動テストファイル生成対応

## 🚀 セットアップ

```bash
# 1. チャットサーバー起動
python claude_chat_server.py

# 2. ブラウザでアクセス（スマートフォン推奨）
# http://127.0.0.1:8081/claude_chat.html
```

## 🏗️ アーキテクチャ

```
[スマートフォンブラウザ] ←→ [HTML/JS UI] ←→ [Python HTTPサーバー] ←→ [Claude Code CLI]
                                ↓                    ↓
                         [ストリーミング]      [メモリ内セッション管理]
                         [進捗表示]           [会話履歴・文脈]
```

## 📋 ファイル構成

- **claude_chat_server.py** - HTTPサーバーとチャットAPI（ストリーミング対応）
- **claude_chat.html** - モダンチャットインターフェース（Markdown対応）
- **REQUIREMENTS.md** - 詳細な要件定義書

## 🔌 API仕様

### ストリーミングチャットエンドポイント
```
POST /api/chat/stream
Content-Type: application/json

{
  "message": "ユーザーメッセージ",
  "session_id": "session_uuid"
}
```

### ストリーミングレスポンス（Server-Sent Events）
```
data: {"type":"init","message":"処理を開始しています..."}
data: {"type":"system","message":"Claude Code初期化中..."}
data: {"type":"assistant","content":"レスポンス内容"}
data: {"type":"result","cost":0.0156,"duration":5876}
data: [DONE]
```

### 通常チャットエンドポイント（フォールバック）
```
POST /api/chat
Content-Type: application/json

{
  "message": "ユーザーメッセージ",
  "session_id": "session_uuid"
}
```

## 💡 使用例

### ファイル作成とリアルタイム進捗
```
「test.py ファイルを作成して」
→ 🔄 処理開始 → ⚙️ 初期化 → 💭 応答中 → ✅ 完了
→ 💰 $0.0127  ⏱️ 4.2秒
```

### 会話の文脈理解
```
Claude: 実行したい具体的なコマンドやファイルを教えてください。例えば：
1. python calculator.py を実行したい
2. claude_chat_server.py のコードを見たい
3. 特定のファイルの内容を読みたい

User: 1
→ Claude が「1番目の選択肢」を理解してcalculator.pyを実行
```

### Markdownファイル表示
```
「README.md を表示して」
→ 見出し、リスト、コードブロックが美しくレンダリング
```

## 🔧 技術詳細

### ストリーミング技術
- **Server-Sent Events**: リアルタイム双方向通信
- **JSON Stream Parser**: Claude Code CLI の stream-json 出力を解析
- **進捗可視化**: アイコン・アニメーション・統計情報表示
- **AbortController**: タイムアウト・キャンセル制御

### セッション管理
- **UUID生成**: セッションごとにユニークID
- **履歴保持**: 50メッセージまで保存、10メッセージをコンテキストとして使用
- **ブラウザ保存**: localStorage でセッションID永続化
- **文脈理解**: 選択肢形式の対話を適切に処理

### エラーハンドリング・信頼性
- **3分タイムアウト**: 長時間処理対応
- **フォールバック機能**: ストリーミング失敗時の通常API自動切り替え
- **接続管理**: 適切なリソース解放とクリーンアップ
- **日本語エラー**: ユーザーフレンドリーなエラーメッセージ

### Markdownレンダリング
- **条件分岐**: .mdファイル時のみフル機能適用
- **軽量パーサー**: カスタム実装による高速処理
- **シンタックスハイライト**: Prism.js統合
- **レスポンシブ**: モバイル最適化デザイン

## 🔒 セキュリティ

### ローカル開発専用設計
- **ローカルホストのみ**: 127.0.0.1 でのみサーバー起動
- **認証なし**: 開発環境での簡単アクセス
- **権限バイパス**: `--dangerously-skip-permissions` フラグ使用

### 注意事項
- **本番環境非対応**: 認証・セキュリティ機能なし
- **ファイル権限**: Claude Code CLIに完全なファイル作成権限を付与
- **ネットワーク**: ローカルネットワーク内でのみ使用推奨

## 🔧 トラブルシューティング

### ストリーミング接続の問題
```bash
# サーバーが起動しているか確認
ps aux | grep claude_chat_server

# ポート8081が使用中でないか確認
netstat -an | grep 8081

# 2回目以降のリクエストでハング → サーバー再起動
```

### タイムアウト・パフォーマンス
- **3分タイムアウト**: 長時間処理は自動でタイムアウト
- **フォールバック**: ストリーミング失敗時は通常モードで再試行
- **進捗表示**: 処理状況が分からない場合は画面で進捗確認

### Markdown表示の問題
- **.mdファイル**: 拡張子やファイル名に「README」「REQUIREMENTS」を含む場合のみMarkdown適用
- **通常ファイル**: コードファイルは最小限のフォーマット（コードブロックと太字のみ）

### Claude Code CLI の問題
```bash
# Claude Code CLIが正しくインストールされているか確認
claude --version

# 権限エラーの場合
claude --print --dangerously-skip-permissions "test"
```

## 📈 パフォーマンス最適化

- **メモ化**: フォーマット結果のキャッシュ
- **ストリーミング**: リアルタイム進捗で体感速度向上
- **レスポンシブ**: requestAnimationFrame による滑らかなスクロール
- **軽量**: 外部依存を最小限に抑制
